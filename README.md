# Система учета отгрузки деталей

Веб-приложение для управления отгрузкой деталей покупателям на базе Go, PostgreSQL и Bootstrap.

## Задача

**15:Покупатели <–>> 14:Учет отгрузки <<–> 02:Детали**

### Задачи

1. **Задача-1**: Сведения об отгрузке деталей покупателям из указанного города
2. **Задача-2**: Сведения об отгрузке деталей покупателям в текущем году с расчетом доли
3. **Задача-3**: Покупатели, для которых все отгрузки дорогих деталей (цена > 100) были только со склада 5

## Технологии

- **Backend**: Go 1.23, Gin Framework
- **Database**: PostgreSQL 17
- **Frontend**: HTML, Bootstrap 4, JavaScript
- **Deployment**: Docker, Docker Compose

## Структура проекта

```
my-kpfu-db-app/
├── cmd/main.go                    # Точка входа приложения
├── internal/
│   ├── config/config.go           # Конфигурация
│   ├── database/database.go       # Подключение к БД
│   ├── domain/models.go           # Модели данных
│   ├── repository/repository.go   # Слой работы с БД
│   └── handler/handler.go         # HTTP обработчики
├── web/templates/                 # HTML шаблоны
│   ├── home.html                  # Главная страница с CRUD
│   ├── view.html                  # VIEW из трех таблиц
│   ├── dynamic.html               # Динамическое отображение
│   ├── task1.html                 # Задача 1
│   ├── task2.html                 # Задача 2
│   └── task3.html                 # Задача 3
├── 0_init.sql                     # SQL схема и данные
├── compose.yaml                   # Docker Compose конфигурация
├── Dockerfile                     # Docker образ приложения
├── Makefile                       # Команды для разработки
├── go.mod                         # Go модули
└── README.md                      # Документация

```

## База данных

### Таблицы

1. **parts** - Справочник деталей
   - PRIMARY KEY: part_code
   - Использует: NOT NULL, CHECK
   
2. **customers** - Покупатели
   - PRIMARY KEY: customer_id (IDENTITY)
   - Использует: NOT NULL, DEFAULT, IDENTITY
   
3. **shipments** - Учет отгрузки
   - PRIMARY KEY: (warehouse_no, shipment_doc_no)
   - Использует: NOT NULL, CHECK, DEFAULT
   - FK к customers (без системного каскада, триггер для удаления)
   - FK к parts (с CASCADE)

### Триггеры

1. **trg_customers_after_delete** - Каскадное удаление отгрузок при удалении покупателя
2. **trg_shipments_after_insert** - Логирование вставок в таблицу аудита

### Хранимая процедура

**p_customer_shipment_summary** - Расчет суммарного количества и стоимости отгрузок для покупателя

### Функции

1. **fn_customer_count_by_city** (скалярная) - Количество покупателей в городе
2. **fn_shipments_in_range** (табличная) - Отгрузки в диапазоне дат

### VIEW

**v_full_shipment_info** - Полная информация об отгрузках (объединение трех таблиц)

## Запуск проекта

### С помощью Docker Compose (рекомендуется)

```bash
# Запуск всех сервисов
docker-compose up --build

# Или через Makefile
make compose-up
```

Приложение будет доступно по адресу: http://localhost:8080

### Локальная разработка

1. Запустить PostgreSQL:
```bash
docker-compose up db -d
```

2. Установить зависимости:
```bash
go mod download
```

3. Запустить приложение:
```bash
make run
# или
go run cmd/main.go
```

### Остановка сервисов

```bash
make compose-down
# или
docker-compose down
```

## Функциональность

### Главная страница (/)

- Отображение всех таблиц (Детали, Покупатели, Отгрузки)
- CRUD операции для всех таблиц
- Результат хранимой процедуры (Label)

### VIEW (/view)

- Представление, объединяющее данные из трех таблиц
- Показывает полную информацию об отгрузках

### Динамическое отображение (/dynamic)

- Выпадающий список для выбора таблицы
- Динамическое отображение данных в одном DataGridView

### Задача 1 (/task-1)

- Форма с параметром (город)
- Два варианта выполнения:
  - SQL-запрос с параметром
  - Обход коллекции объектов (ORM)

### Задача 2 (/task-2)

- Отгрузки текущего года
- SQL с оконными функциями
- Расчет доли от общего количества

### Задача 3 (/task-3)

- Кванторный SQL-запрос с подзапросами
- Record-ориентированный подход (обход коллекций)
- Переключение между методами

## API Endpoints

### CRUD операции

- `POST /api/parts` - Создать деталь
- `PUT /api/parts/:code` - Обновить деталь
- `DELETE /api/parts/:code` - Удалить деталь

- `POST /api/customers` - Создать покупателя
- `PUT /api/customers/:id` - Обновить покупателя
- `DELETE /api/customers/:id` - Удалить покупателя

- `POST /api/shipments` - Создать отгрузку
- `PUT /api/shipments/:warehouse/:doc` - Обновить отгрузку
- `DELETE /api/shipments/:warehouse/:doc` - Удалить отгрузку

### Задачи

- `GET /api/task-1/sql?city=Казань` - Задача 1 (SQL)
- `GET /api/task-1/orm?city=Казань` - Задача 1 (ORM)
- `GET /api/task-2` - Задача 2
- `GET /api/task-3/sql` - Задача 3 (SQL)
- `GET /api/task-3/record` - Задача 3 (Record-based)

### Дополнительно

- `GET /api/table/:name` - Динамическое получение данных таблицы
- `GET /api/procedure/:customer_id` - Вызов хранимой процедуры

## Тестовые данные

База данных автоматически инициализируется тестовыми данными:
- 8 деталей (некоторые с ценой > 100)
- 7 покупателей (в разных городах, включая Казань)
- 18 отгрузок (с разных складов, включая склад 5, за 2024-2025 годы)

## Разработка

### Структура кода

- **cmd/** - Точка входа приложения
- **internal/config/** - Загрузка конфигурации
- **internal/database/** - Подключение к БД
- **internal/domain/** - Модели данных
- **internal/repository/** - Репозиторий (работа с БД)
- **internal/handler/** - HTTP обработчики
- **web/templates/** - HTML шаблоны

### Добавление новой функциональности

1. Добавить модель в `internal/domain/models.go`
2. Добавить методы в `internal/repository/repository.go`
3. Добавить обработчики в `internal/handler/handler.go`
4. Создать HTML шаблон в `web/templates/`

## Требования к заданию

### База данных

- ✅ Три таблицы созданы
- ✅ NOT NULL, DEFAULT, PRIMARY KEY, CHECK, IDENTITY используются
- ✅ Две межтабличные связи (одна без CASCADE + триггер, другая с CASCADE)
- ✅ Два триггера (каскадное удаление и логирование)
- ✅ Хранимая процедура с выходными параметрами
- ✅ Скалярная и табличная функции
- ✅ Тестовые данные загружены (≥5 строк в каждой таблице)

### Клиентская часть

- ✅ Главная форма с таблицами и CRUD операциями
- ✅ Альтернативная форма с динамическим отображением
- ✅ VIEW из трех таблиц на отдельной форме
- ✅ Результат хранимой процедуры в Label
- ✅ Задача-1: два варианта (SQL и ORM) с входным параметром
- ✅ Задача-2: SQL с оконными функциями
- ✅ Задача-3: кванторный SQL и record-ориентированный подход

## Автор

Студент КФУ

## Лицензия

MIT

